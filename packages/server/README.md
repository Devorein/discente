# `@discente/server`

## Setup

1. Create a `.env` file with the keys mentioned [here](#environment-variables-development)
2. Make sure you have postgres server installed and running.
3. Run `npm run setup-db` to setup/teardown development database and apply migration against it
4. Run `npm run dev` to start the development server and the tsc compiler(in watch mode) simultaneously. It should be running at `http://localhost:${SERVER_PORT}`

## Stack

1. `Express`: A Backend web application framework
2. `postgres`: Open Source RDBMS
3. `Prisma`: Next-generation Node.js and TypeScript ORM
4. `Typescript`: Type safety for JS
5. `yup`: Schema validation library
6. `argon2`: a simple password-hashing function
7. `axios`: HTTP Client for making api requests
8. `morgan, winston`: HTTP request logger middleware
9. `jsonwebtoken`: JWT library used for signing cookies

## Folder organization

- `.coverage`: Hidden folder created by jest to store coverage reports
- `dist`: Hidden folder created by typescript to emit all the transpiled js server code
- `logs`: Hidden file generated by `winston` to store all logs
- `prisma`: Contains prisma schema and migrations
- `src`: Source code
  - `controllers`: API request handlers. Each module is for a single entity or service
  - `lib`: Internal business logic consumed by controllers
  - `middlewares`: Express middlewares
  - `routers`: Express routers. Each module is for a single entity or service
  - `utils`: Generic and common utility functions. Not to be confused with `lib`.
  - `config.ts`: Exports environment variables to be consumed with guaranteed type safety and defaults
  - `express.d.ts`: Type augmentation for `express`
  - `types`: Types exported by `@prisma/client` and backend
- `tests`: All the tests are located here.
  - `controllers`: Integration tests for `/src/controllers`
  - `lib`: Unit + integration tests for `/src/lib`
  - `utils`: Unit tests for `/src/utils`

## Testing

1. Run `setup-db:test` to setup/teardown test database and apply migration against it
2. Run `start:test` to start the server in testing environment (make sure the code has been build first using `npm run build`)
3. Run `npm run test` to run the unit and integration tests

## Environment variables (development)

**NOTE** This must be named `.env`

- `SERVER_PORT`: Port where the server will listen for incoming requests
- `DB_URL`: Connection string for database (includes username, password, host, port and database name)
- `CLIENT_URL`: Url where the next.js server (frontend) is hosted/running
- `PASSWORD_SALT`: Random string added to password before hashing to strengthen it
- `JWT_SECRET`: Random string added before signing a JWT
- `JWT_ALGORITHM`: Algorithm used to sign jwt token
- `NODE_ENV`: Current node environment (`development`, `staging`, `testing` & `production`)

**NOTE** See `.env.test` in the same directory to see an example environment variable file.

## Environment variables (testing)

**NOTE** This must be named `.env.test`

The same keys as `.env` with a few additional ones

- `SERVER_URL`: Url where the test server is running
